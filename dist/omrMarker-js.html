<script>
/******omr 관련 ************/
  const markOmr = async function(){
    const omrFileId = '1AeeIPV2aDhymH7X4wyX4t2T4ai1oPOHD'
    const img = new Image();
    const srcData = await asyncRun({ serverFunction: 'fileDataToClient', args:[omrFileId]}) 
    img.src = srcData
    
    const canvas = document.querySelector('#canvas')
    let c = canvas.getContext('2d');
    c.fillStyle = 'black'; 

    //canvas clear하고 img 다시 띄움 
    const imgLoad = function () {
      c.clearRect(0, 0, canvas.width, canvas.height);
      c.beginPath();
      c.drawImage(img, 0, 0);
    }
    
    //from stackflow - canvas에 ellipse 그리는 함수
    function drawEllipseByCenter(c, cx, cy) {
      w = 6;
      h = 14;
      drawEllipse(c, cx - w/2.0, cy - h/2.0, w, h);
    }

    function drawEllipse(c, x, y, w, h) {
      var kappa = .5522848,
          ox = (w / 2) * kappa, // control point offset horizontal
          oy = (h / 2) * kappa, // control point offset vertical
          xe = x + w,           // x-end
          ye = y + h,           // y-end
          xm = x + w / 2,       // x-middle
          ym = y + h / 2;       // y-middle

      c.beginPath();
      c.moveTo(x, ym);
      c.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
      c.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
      c.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
      c.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
      c.stroke();
      c.fill();
    }

    //시트 정보를 잘라주는 역할을 하는 함수
    const reframeData = function (data){
      return {
            'userName' : data[0], 
            'userCode' : data[1],
            'examCode' : data[2],
            'answers' : data.slice(3,)
      }
    }
    //omr 위 사각형으로 위치 잡는 객체
    class answerBox {
      constructor(startx, starty){
        this.startx = startx;
        this.starty = starty;
        this._boxWidth = 21.5;
        this._boxHeight = 36;
      }
      //실제로 마킹하는 함수(ellipseByCenter는 상자 중심을 인수로 넘겨줘야 함)
      markEllipse = function (x, y){
        drawEllipseByCenter(c, x + this._boxWidth / 2, y + this._boxHeight / 2);
      };
      //마킹좌표 잡는 함수(count: 자릿수(x축) , number: 수(y축))
      markRow = function(count, number) {
        this.markEllipse(this.startx + count * this._boxWidth, this.starty + number * this._boxHeight);
      }
    }
    //마킹 
    const codeMarking = function (numberCode, x, y, total) {
      const standard = new answerBox(x, y);
      //길이 체크 
      if (numberCode.length > total){
        throw new Error; 
      }
      else if(total == 5 && (total != numberCode.length || numberCode.length == 0)){
        throw new Error;
      }
      let count = total - numberCode.length; //자릿수에 맞게 들어가게 함
      for (let i of numberCode){
        standard.markRow(count++, i);
      }
    }
    //시작 좌표들
    const startXY = {'userCode' : [271, 457], 
                    'examCode' : [400, 457],
                    'answers' : [[547, 155], [622, 155], [697, 155],
                                [785, 155], [860, 155], [935, 155],
                                [1023, 155], [1098, 155], [1173, 155],
                                [547, 548], [622, 548], [697, 548],
                                [785, 548], [860, 548], [935, 548]]}
    //시트에서 데이터 읽어옴
    const answerData = await asyncRun({ serverFunction: 'getSheetData'}) 
    const urlArray = []; //다운로드를 위해 각 canvas url 저장배열
    
    for(let singleOmr of answerData){
      imgLoad(); //canvas 초기화 함수
      singleOmr = reframeData(singleOmr);
      try{
        codeMarking(singleOmr.userCode, startXY.userCode[0], startXY.userCode[1], 5);
        codeMarking(singleOmr.examCode, startXY.examCode[0], startXY.examCode[1], 5);
        let count = 0;
        for (num of singleOmr.answers){
          codeMarking(num, startXY.answers[count][0], startXY.answers[count++][1], 3);
        }
        urlArray.push({'name' : `${singleOmr.userName}_${singleOmr.userCode}_${singleOmr.examCode}.png`, 
                        'url' : canvas.toDataURL()});
      }catch{
        console.log(`Skiped ${singleOmr.userCode}`);
      }
    }
    
    // //사진으로 저장하는 부분
    document.querySelector('#downloadOmr').addEventListener('click', event =>{
      for(urls of urlArray){
        let link = document.createElement('a')
        link.download= `${urls.name}`
        link.href = `${urls.url}`
        link.click();
        URL.revokeObjectURL(link.href)
      };
    });
  }

</script>
